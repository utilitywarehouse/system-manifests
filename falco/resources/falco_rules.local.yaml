# From: https://falco.org/docs/reference/rules/default-macros/
# macro `always_true` is the flip side of the macro `never_true`but is
# commented out in the default configuration shipped with falco, as it is not
# used. Bringing it in since we want to use it below.
- macro: always_true
  condition: (evt.num>=0)

# We have a ;lot of things that are talking to apiservers, for example this
# rule reports a lot of activity from Mongo orchestrators in dev environments.
# Instead of trying to police every request and whitelist, it should be safe to
# just allow all and rely on audit logs to trace access to apiservers.
- macro: k8s_containers
  condition: (always_true)

# Patch "Packet socket created in container" rule to avoid catching metallb
# pods, which are expected to violate it.
- rule: Packet socket created in container
  desc: >
    Detect new packet socket at the device driver (OSI Layer 2) level in a container. Packet socket could be used for ARP Spoofing 
    and privilege escalation (CVE-2020-14386) by an attacker. Noise can be reduced by using the user_known_packet_socket_binaries
    template list.
  condition: > 
    evt.type=socket
    and container 
    and evt.arg.domain contains AF_PACKET 
    and not proc.name in (user_known_packet_socket_binaries)
    and not k8s.ns.name in (sys-metallb)
  output: Packet socket was created in a container | socket_info=%evt.args connection=%fd.name lport=%fd.lport rport=%fd.rport fd_type=%fd.type fd_proto=%fd.l4proto evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname command=%proc.cmdline terminal=%proc.tty
  priority: NOTICE
  tags:
    [maturity_stable, container, network, mitre_credential_access, T1557.002]

# Patch "Redirect STDOUT/STDIN to Network Connection in Container" rule to reduce noise
# https://github.com/falcosecurity/rules/blob/main/rules/falco_rules.yaml#L1007-L1019
# https://github.com/falcosecurity/rules/issues/131
- rule: Redirect STDOUT/STDIN to Network Connection in Container
  condition: >
    dup 
    and container 
    and evt.rawres in (0, 1, 2) 
    and fd.type in (ip_sockets) 
    and fd.types[0] in (ip_sockets) 
    and fd.types[1] in (ip_sockets) 
    and fd.types[2] in (ip_sockets) 
    and not user_known_stand_streams_redirect_activities
  override:
    condition: replace

# 
# UW Custom rules
# 

# Rule: Interactive Executions in Containers
# is modified version of 'Terminal shell in container' default rule 
#
# WHAT IT DETECTS
# 1. TTY Sessions (proc.tty != 0):
#   standard interactive sessions where a terminal (PTY) is allocated.
#   - kubectl exec -it my-pod -- sh  (and all commands run inside that shell)
#   - kubectl exec -it my-pod -- ls -la
# 2. Pipe-Interactive Sessions (stdin=pipe & container_entrypoint):
#    Catches executions where stdin is open (flag `-i`), allowing data injection 
#    without a full TTY. Commonly used to pipe scripts into containers.
#    - `echo "ls -al" | kubectl exec -i my-pod -- sh`
# 
# WHAT IT MISSES (Intentional Exclusion):
#    Non-interactive execs (e.g.,  (without -it)) are NOT captured.
#    - `kubectl exec my-pod -- ls -la`
#   
#   REASON:
#   At the kernel level, non-interactive execs are effectively indistinguishable from Kubernetes 
#   Liveness/Readiness probes (both have tty=0 and stdin=/dev/null). 
#   Enabling detection here would flood logs with valid probe activity.
#   These should be monitored via Kubernetes API Audit Logs instead.
#
# 
# GH action runner produces noisy logs with tty attached for `apt-get`
# we have 'Drop and execute new binary in container' rule to capture executions 
# from external bin
- macro: interactive_exec_exceptions
  condition: >
    (
      k8s.ns.name = sys-actions and proc.aname = apt-get
    )

- rule: Interactive Executions in Containers
  desc: Detects any process running with an attached terminal (TTY) inside a container, indicating interactive user activity.
  condition: >
    spawned_process
    and container
    and proc.tty != 0
    and not interactive_exec_exceptions
  output: >
    Interactive Process Started | evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname gparent=%proc.aname[2] command=%proc.cmdline terminal=%proc.tty exe_flags=%evt.arg.flags sname=%proc.sname sid_exe=%proc.sid.exe pid=%proc.pid ppid=%proc.ppid pvpid=%proc.pvpid vpid=%proc.vpid vpgid=%proc.vpgid sid=%proc.sid
  priority: INFO
  tags: [process, mitre_execution]
