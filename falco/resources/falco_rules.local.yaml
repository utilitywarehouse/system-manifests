# From: https://falco.org/docs/reference/rules/default-macros/
# macro `always_true` is the flip side of the macro `never_true`but is
# commented out in the default configuration shipped with falco, as it is not
# used. Bringing it in since we want to use it below.
- macro: always_true
  condition: (evt.num>=0)

# We have a ;lot of things that are talking to apiservers, for example this
# rule reports a lot of activity from Mongo orchestrators in dev environments.
# Instead of trying to police every request and whitelist, it should be safe to
# just allow all and rely on audit logs to trace access to apiservers.
- macro: k8s_containers
  condition: (always_true)

# Patch "Packet socket created in container" rule to avoid catching metallb
# pods, which are expected to violate it.
- rule: Packet socket created in container
  desc: >
    Detect new packet socket at the device driver (OSI Layer 2) level in a container. Packet socket could be used for ARP Spoofing 
    and privilege escalation (CVE-2020-14386) by an attacker. Noise can be reduced by using the user_known_packet_socket_binaries
    template list.
  condition: > 
    evt.type=socket
    and container 
    and evt.arg.domain contains AF_PACKET 
    and not proc.name in (user_known_packet_socket_binaries)
    and not k8s.ns.name in (sys-metallb)
  output: Packet socket was created in a container | socket_info=%evt.args connection=%fd.name lport=%fd.lport rport=%fd.rport fd_type=%fd.type fd_proto=%fd.l4proto evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname command=%proc.cmdline terminal=%proc.tty
  priority: NOTICE
  tags:
    [maturity_stable, container, network, mitre_credential_access, T1557.002]

# Patch "Redirect STDOUT/STDIN to Network Connection in Container" rule to reduce noise
# https://github.com/falcosecurity/rules/blob/main/rules/falco_rules.yaml#L1007-L1019
# https://github.com/falcosecurity/rules/issues/131
- rule: Redirect STDOUT/STDIN to Network Connection in Container
  condition: >
    dup 
    and container 
    and evt.rawres in (0, 1, 2) 
    and fd.type in (ip_sockets) 
    and fd.types[0] in (ip_sockets) 
    and fd.types[1] in (ip_sockets) 
    and fd.types[2] in (ip_sockets) 
    and not user_known_stand_streams_redirect_activities
  override:
    condition: replace

# 
# UW Custom rules
# 


# Liveness, Readiness and Startup Probes are executed by containerd-shim
# so it sims like an container_entrypoint
# kubectl get deployment,sts,ds --all-namespaces --output=json   | jq --raw-output '
#       .items[]
#       | .metadata.name as $name
#       | (.spec.template.spec.containers[], .spec.template.spec.initContainers[]?)
#       | (.livenessProbe, .readinessProbe, .startupProbe)
#       | .exec.command
#       | select(. != null)
#       | "\(join(" "))"
#     '
- macro: known_liveness_readiness_probes
  condition: >
    (
     proc.cmdline = "calico-node -felix-live -bird-live"
     or proc.cmdline = "calico-node -felix-ready -bird-ready"
     or proc.cmdline = "check-status -l"
     or proc.cmdline = "check-status -r"
     or proc.cmdline = "pgrep memcached"
     or proc.cmdline endswith "/health/redis_liveness.sh"
     or proc.cmdline endswith "/health/redis_readiness.sh"
     or proc.cmdline endswith "/health/sentinel_liveness.sh"
     or proc.cmdline glob "csi-node-driver --kubelet-registration-path=* --mode=kubelet-registration-probe"
     or proc.cmdline glob "sh -c while ! nc -w 1 127.0.0.1 8098; do sleep 1; done?"
    )

# modified 'Terminal shell in container' rule 
#  `proc.tty != 0`: Catches standard interactive shells where a terminal is allocated.
#   kubectl exec -it my-pod -- sh -c "ls -la"
#   kubectl exec -it my-pod -- ls -la
#   kubectl exec -it my-pod -- /bin/sh and then also capture all cmd executed in that session
# 
#  `container_entrypoint`: Catches processes spawned directly by containerd-shim
#   kubectl exec my-pod -- ls -la (without -it)
#   In this case, the 'ls' process appears as a child of the container runtime (containerd-shim)
#   This also adds little noise as we also capture all containers entry-points
# 
- rule: All Container Entrypoints and Interactive Executions
  desc: Logs all interactive sessions (TTY) and any processes executed directly by the container runtime.
  condition: >
    spawned_process
    and container
    and (proc.tty != 0 or container_entrypoint)
    and not known_liveness_readiness_probes
  output: >
    Interactive Process Started | evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname gparent=%proc.aname[2] command=%proc.cmdline terminal=%proc.tty exe_flags=%evt.arg.flags
  priority: INFO
  tags: [process, mitre_execution]


# modified outbound macro to 
# also skip connections to `::1` and port == "0"
- macro: uw_outbound
  condition: >
    ((evt.type = connect or
      (evt.type in (sendto,sendmsg) and
       fd.l4proto != tcp and fd.connected=false and fd.name_changed=true)) and
     (fd.typechar = 4 or fd.typechar = 6) and
     (fd.ip != "0.0.0.0" and fd.net != "127.0.0.0/8" and fd.port != "0" and fd.sip != "::1" and not fd.snet in (rfc_1918_addresses)) and
     (evt.rawres >= 0 or evt.res = EINPROGRESS))

- rule: Log Outbound External Connections
  desc: Log any network connection that goes outside the cluster
  condition: >
    uw_outbound
    and container
  output: >
    Outbound Network Traffic | connection=%fd.name sdomain=%fd.sip.name srcip=%fd.cip dstip=%fd.sip dstport=%fd.sport fd_type=%fd.type fd_proto=%fd.l4proto evt_type=%evt.type user=%user.name user_uid=%user.uid user_loginuid=%user.loginuid process=%proc.name proc_exepath=%proc.exepath parent=%proc.pname command=%proc.cmdline terminal=%proc.tty
  priority: INFO
  tags: [network, mitre_exfiltration]
