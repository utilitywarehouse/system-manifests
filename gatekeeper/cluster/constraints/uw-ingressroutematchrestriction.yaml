# prevent ingressroutetcps from hijacking all traffic by preventing wildcard
# HostSNIs
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: IngressRouteMatchRestriction
metadata:
  name: wildcard-hostsni
spec:
  match:
    kinds:
      - apiGroups: ["traefik.containo.us"]
        kinds: ["IngressRouteTCP"]
  parameters:
    message: "HostSNI rules must not contain a wildcard host '*'"
    matchRegex: "HostSNI\\(.*(`\\*`)+.*\\)"
    exceptions: []
---
# using || can allow you to subvert other restrictions and hijack traffic with
# non-specific rules that match generic paths or headers
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: IngressRouteMatchRestriction
metadata:
  name: or-operator
spec:
  match:
    kinds:
      - apiGroups: ["traefik.containo.us"]
        kinds: ["IngressRoute", "IngressRouteTCP"]
  parameters:
    message: "Route matches must not contain ||"
    matchRegex: "\\|\\|"
    exceptions: []
---
# The regular expression used here was adapted from the validation Kubernetes
# performs on the host field of Ingress rules, which adheres to RFC 1123:
# - https://github.com/kubernetes/kubernetes/blob/18856dace935db46d3ba84374ce23438922e272b/staging/src/k8s.io/apimachinery/pkg/util/validation/validation.go#L198
#
# That validation is wrapped in patterns that match the following forms:
# - Host(`<host>`)
# - Host(`<host>`, `<host>`...)
#
# The use of the 'inverse' parameter here, combined with this pattern, makes it
# so that every IngressRoute match must contain a specific host with a valid hostname
# as defined by RFC 1123.
#
# By requiring a Host rule, we prevent widespread hijacking by non-specific
# rules like PathPrefix(`/`).
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: IngressRouteMatchRestriction
metadata:
  name: require-host
spec:
  match:
    kinds:
      - apiGroups: ["traefik.containo.us"]
        kinds: ["IngressRoute"]
  parameters:
    message: "All route matches must contain a Host rule with valid hostnames as defined by RFC 1123"
    matchRegex: "Host\\((`(([a-zA-Z0-9]{1,})|([a-zA-Z0-9]+(-[a-zA-Z0-9]+)*\\.)+[a-z]{2,})`(, ?)?)+\\)"
    inverse: true
    exceptions: []
