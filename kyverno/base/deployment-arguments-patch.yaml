# Patches Kyverno deployment arguments
#
# -v=0 lowers logging verbisity as Kyverno tends to get chatty during background
# operations and logs were dropper by the forwarders
#
# --autogenInternals=false comes from upstream since v1.8. It means that Kyverno
# will not try to patch policies and add rules for controller objects. For
# example a policy for a Pod will not be patched to filter admission of
# Deployments, ReplicaSets... Kyverno will still stop admission of Pods which
# violate a policy, which is equivalent to how PodSecurityPolicies used to
# operate.
#
# --autoUpdateWebhooks=false will configure Kyverno to create the default
# webhook configurations that forwards admission requests for all resources
# and with FailurePolicy set to Ignore:
# https://kyverno.io/docs/installation/#webhooks
# That will allow us to pass all admission requests when Kyverno is crashing,
# and we should rely on background checks and alerts to catch potential
# violations during Kyverno downtime.
#
# --admissionReports=false
# --backgroundScan=false
# If both backgroundScan and admissionReports are set to false the entire
# reports system will be disabled.
# https://github.com/kyverno/kyverno/blob/main/CHANGELOG.md#v180-rc3
# We saw that the Kyverno reporting system, introduced with version v1.7, will
# produce thousands of admissionreports and backgroundscanreports objects, which
# can hammer etcd members and will definitely double the db size. Disabling will
# not stop Kyverno from doing periodic background policy checks and update the
# metric we rely on to be alerted on violations.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyverno
spec:
  template:
    spec:
      containers:
      - args:
        - -v=0
        - --autogenInternals=false
        - --autoUpdateWebhooks=false
        - --admissionReports=false
        - --backgroundScan=false
        name: kyverno
