apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: external-dns-ingress-length
  annotations:
    policies.kyverno.io/title: External-DNS Ingress Length Limit
    policies.kyverno.io/category: External-DNS
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Ingress
    policies.kyverno.io/description: >-
      External-DNS uses TXT records to flag ownership of DNS records. For that
      purpose it uses the following tag `heritage=external-dns,external-dns/owner=<owner>,external-dns/resource=ingress/<namespace>/<name>`.
      There is a limitatiin that this cannot be >= 255 chars long, which is
      not verified by External-DNS and as a result applying DNS changes could
      fail.
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: external-dns-txt-labels-limit
      match:
        resources:
          kinds:
            - Ingress # Starting with capital letter seems to be significant for policy validation on admission
          annotations:
            external-dns.alpha.kubernetes.io/target: "*"
      preconditions:
        all:
          - key: "{{ request.operation }}"
            operator: NotEquals
            value: DELETE
      validate:
        message: "External-DNS TXT record ownership labe must be less than 255 chars"
        deny:
          conditions:
            - key: >-
                {{ join('/', ['heritage=external-dns,external-dns/owner=infra,external-dns/resource=ingress', request.object.metadata.namespace, request.object.metadata.name]) | length(@) }}
              operator: GreaterThanOrEquals
              value: 255
