# https://main.kyverno.io/policies/argo/application-field-validation/application-field-validation/
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: application-field-validation
  annotations:
    policies.kyverno.io/title: Application Field Validation
    policies.kyverno.io/category: Argo
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Application
    kyverno.io/kyverno-version: 1.6.0
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      This policy performs some best practices validation on Application fields.
      project name should not be empty.
      source.path should be specified and not the helm chart.
      destination.name or destination.server should be specified but never both.
      destination.namespace should match own namespace
spec:
  validationFailureAction: audit
  background: true
  rules:
    - name: empty-project
      match:
        any:
          - resources:
              kinds:
                - Application
      validate:
        message: >-
          `spec.project` should not be empty.
        pattern:
          - spec:
              project: "?*"
    - name: source-path-chart
      match:
        any:
          - resources:
              kinds:
                - Application
      validate:
        message: >-
          `spec.source.path` should be specified and not the helm chart.
        anyPattern:
          - spec:
              source:
                path: "?*"
                X(chart):
    - name: destination-server-name
      match:
        any:
          - resources:
              kinds:
                - Application
      validate:
        message: >-
          `spec.destination.server` OR `spec.destination.name` should be specified but never both.
        anyPattern:
          - spec:
              destination:
                server: "?*"
                X(name):
          - spec:
              destination:
                X(server):
                name: "?*"
    - name: destination-namespace
      match:
        any:
          - resources:
              kinds:
                - Application
      validate:
        message: >-
          `spec.destination.namespace`should match application's own namespace.
        pattern:
          spec:
            destination:
              namespace: "{{request.object.namespace}}"
