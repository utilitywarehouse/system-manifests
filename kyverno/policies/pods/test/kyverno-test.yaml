apiVersion: cli.kyverno.io/v1alpha1
kind: Test
metadata:
  name: pods-policies
policies:
  - ../hostIPC.yaml
  - ../hostNetwork.yaml
  - ../privilege-escalation.yaml
  - ../replace-annotation.yaml
resources:
  - test-hostIPC.yaml
  - test-hostNetwork.yaml
  - test-privilege-escalation.yaml
  - test-replace-annotation.yaml
results:
  # Test hostIPC
  - policy: disallow-host-ipc-pods
    rule: default
    resource: test-hostIPC-not-set
    kind: Pod
    result: pass
  - policy: disallow-host-ipc-pods
    rule: default
    resource: test-hostIPC-set-to-false
    kind: Pod
    result: pass
  - policy: disallow-host-ipc-pods
    rule: default
    resource: test-hostIPC-set-to-true
    kind: Pod
    result: fail
  # Test hostNetwork
  - policy: disallow-host-network-pods
    rule: default
    resource: test-hostNetwork-not-set
    kind: Pod
    result: pass
  - policy: disallow-host-network-pods
    rule: default
    resource: test-hostNetwork-set-to-false
    kind: Pod
    result: pass
  - policy: disallow-host-network-pods
    rule: default
    resource: test-hostNetwork-set-to-true
    kind: Pod
    result: fail
  # Test privilege escalation
  - policy: disallow-privilege-escalation
    rule: default
    resource: test-privilege-escalation-not-set
    kind: Pod
    result: pass
  - policy: disallow-privilege-escalation
    rule: default
    resource: test-privilege-escalation-set-to-false
    kind: Pod
    result: pass
  - policy: disallow-privilege-escalation
    rule: default
    resource: test-privilege-escalation-set-to-true
    kind: Pod
    result: fail
  # Test Replace Annotation
  - policy: replace-annotations
    rule: replace-injector-tumblr-com-request
    resource: test-with-injector-tumblr-com-request-aws
    patchedResource: patched-replace-annotation.yaml
    kind: Pod
    result: pass
  - policy: replace-annotations
    rule: replace-injector-tumblr-com-request
    resource: test-with-injector-tumblr-com-request-gcp
    patchedResource: patched-replace-annotation.yaml
    kind: Pod
    result: pass
  - policy: replace-annotations
    rule: replace-injector-tumblr-com-request
    resource: test-without-injector-tumblr-com-request
    patchedResource: patched-replace-annotation.yaml
    kind: Pod
    result: pass
  - policy: replace-annotations
    rule: replace-injector-tumblr-com-request
    resource: test-old-new-annotation
    patchedResource: patched-replace-annotation.yaml
    kind: Pod
    result: pass
