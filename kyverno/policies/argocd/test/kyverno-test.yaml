apiVersion: cli.kyverno.io/v1alpha1
kind: Test
metadata:
  name: test-argocd-policies
policies:
  - ../application-field-validation.yaml
  - ../application-prevent-default-project.yaml
  - ../add-ignore-resource-updates-annotation.yaml
resources:
  - test-application-prevent-default-project.yaml
  - test-application-field-validation.yaml
  - test-add-ignore-resource-updates-annotation.yaml
results:
  # Test default-project
  - policy: argocd-application-prevent-default-project
    rule: default-project
    kind: Application
    resource: test-custom-project
    result: pass
  - policy: argocd-application-prevent-default-project
    rule: default-project
    kind: Application
    resource: test-default-project
    result: fail
  - policy: argocd-application-prevent-default-project
    rule: default-project
    kind: Application
    resource: test-missing-project-name
    result: fail

  # Test Application Fields validation
  - policy: argocd-application-field-validation
    rule: empty-project
    kind: Application
    resource: test-missing-project-name
    result: fail
  - policy: argocd-application-field-validation
    rule: empty-source-path
    kind: Application
    resource: test-missing-source-path
    result: fail
  - policy: argocd-application-field-validation
    rule: empty-source-path
    kind: Application
    resource: test-source-path-specified
    result: pass
  - policy: argocd-application-field-validation
    rule: chart-should-not-be-used
    kind: Application
    resource: test-source-path-chart-specified
    result: fail
  - policy: argocd-application-field-validation
    rule: empty-destination-namespace
    kind: Application
    resource: test-missing-destination-namespace
    result: fail

  # Test Add Ignore Update Annotations On Child Resources
  - policy: argocd-add-ignore-resource-updates-annotation
    rule: add-ignore-resource-updates-annotations-pods
    kind: Deployment
    resources: [deploy-with-argocd-tracking]
    patchedResource: patched-add-ignore-resource-updates-annotation.yaml
    result: pass
  - policy: argocd-add-ignore-resource-updates-annotation
    rule: add-ignore-resource-updates-annotations-pods
    kind: DaemonSet
    resources: [with-argocd-tracking]
    patchedResource: patched-add-ignore-resource-updates-annotation.yaml
    result: pass
  - policy: argocd-add-ignore-resource-updates-annotation
    rule: add-ignore-resource-updates-annotations-cronjob
    kind: CronJob
    resources: [with-argocd-tracking]
    patchedResource: patched-add-ignore-resource-updates-annotation.yaml
    result: pass
  - policy: argocd-add-ignore-resource-updates-annotation
    rule: add-ignore-resource-updates-annotations-pods
    kind: StatefulSet
    resources: [without-argo-tracking]
    result: skip
  - policy: argocd-add-ignore-resource-updates-annotation
    rule: add-ignore-resource-updates-annotations-pods
    kind: Deployment
    resources: [with-argocd-tracking-and-update-ignore-annotation]
    result: skip
